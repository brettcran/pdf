
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDFill-Sign Final Fix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body.light { background: #f5f5f5; color: #000; }
    body.dark { background: #1e1e1e; color: #fff; }
    body { margin: 0; font-family: Arial; transition: background 0.3s, color 0.3s; }

    .sidebar {
      width: 72px;
      background: #2f2f2f;
      position: fixed;
      top: 0; bottom: 0; left: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 0;
      z-index: 1000;
    }

    .sidebar button {
      background: none;
      border: none;
      margin: 10px 0;
      cursor: pointer;
      font-size: 20px;
      color: white;
    }

    #pdf-container {
      margin-left: 72px;
      padding: 20px;
      overflow-y: auto;
      height: 100vh;
      position: relative;
    }

    canvas {
      display: block;
      margin-bottom: 20px;
      background: white;
      border: 1px solid #ccc;
    }

    .draggable {
      position: absolute;
      font-weight: bold;
      cursor: move;
      user-select: none;
      font-family: Arial;
    }

    #settings-modal, #backdrop {
      display: none;
      position: fixed;
      z-index: 1001;
    }

    #backdrop {
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      top: 0; left: 0;
      z-index: 1000;
    }

    #settings-modal {
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      color: #000;
    }

    #settings-modal select, #settings-modal button {
      display: block;
      margin: 10px 0;
      width: 100%;
    }
  </style>
</head>
<body class="light">

<div class="sidebar">
  <button onclick="triggerUpload()">üìÇ</button>
  <button onclick="setMode('text')">T</button>
  <button onclick="setMode('check')">‚úî</button>
  <button onclick="setMode('x')">‚úñ</button>
  <button onclick="exportPDF()">‚¨á</button>
  <button onclick="openSettings()">‚öôÔ∏è</button>
</div>

<input type="file" id="file-input" accept="application/pdf" style="display:none"/>
<div id="pdf-container"></div>

<div id="backdrop" onclick="closeModals()"></div>
<div id="settings-modal">
  <label>Font:</label>
  <select id="fontSelect">
    <option>Arial</option><option>Helvetica</option><option>Times New Roman</option>
  </select>
  <label>Font Size:</label>
  <select id="fontSize">
    <option>12</option><option>14</option><option>16</option><option>18</option><option>20</option>
  </select>
  <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const fileInput = document.getElementById("file-input");
  const container = document.getElementById("pdf-container");
  const fontSelect = document.getElementById("fontSelect");
  const fontSize = document.getElementById("fontSize");
  let pdf = null;
  let mode = null;
  let annotations = [];

  function triggerUpload() {
    fileInput.click();
  }

  fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      const typedarray = new Uint8Array(reader.result);
      pdfjsLib.getDocument({ data: typedarray }).promise.then(doc => {
        pdf = doc;
        renderAllPages();
      });
    };
    reader.readAsArrayBuffer(file);
  });

  function setMode(m) {
    mode = m;
  }

  function renderAllPages() {
    container.innerHTML = "";
    for (let i = 1; i <= pdf.numPages; i++) {
      pdf.getPage(i).then(page => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const scale = 1.25;
        const viewport = page.getViewport({ scale });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        canvas.dataset.page = i;
        page.render({ canvasContext: ctx, viewport }).promise.then(() => {
          container.appendChild(canvas);
        });
        canvas.addEventListener("click", e => handleCanvasClick(e, canvas));
      });
    }
  }

  function handleCanvasClick(e, canvas) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left + canvas.offsetLeft;
    const y = e.clientY - rect.top + canvas.offsetTop;

    let el = document.createElement("div");
    el.className = "draggable";
    el.style.left = `${x}px`;
    el.style.top = `${y}px`;
    el.style.fontFamily = fontSelect.value;
    el.style.fontSize = fontSize.value + "px";

    if (mode === "text") {
      el.textContent = "Enter text";
      el.contentEditable = true;
    } else if (mode === "check") {
      el.textContent = "‚úî";
    } else if (mode === "x") {
      el.textContent = "‚úñ";
    } else {
      return;
    }

    makeDraggable(el);
    container.appendChild(el);
    annotations.push({ el, canvas });
  }

  function makeDraggable(el) {
    el.onmousedown = function (e) {
      const offsetX = e.clientX - el.offsetLeft;
      const offsetY = e.clientY - el.offsetTop;
      function moveAt(e) {
        el.style.left = `${e.clientX - offsetX}px`;
        el.style.top = `${e.clientY - offsetY}px`;
      }
      document.onmousemove = moveAt;
      document.onmouseup = () => document.onmousemove = null;
    };
    el.ondragstart = () => false;
  }

  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const canvases = Array.from(container.querySelectorAll("canvas"));
    const pdfDoc = new jsPDF({ unit: "px", format: [canvases[0].width, canvases[0].height] });

    canvases.forEach((canvas, idx) => {
      const img = canvas.toDataURL("image/png");
      pdfDoc.addImage(img, 'PNG', 0, 0, canvas.width, canvas.height);

      annotations
        .filter(a => a.canvas === canvas)
        .forEach(a => {
          const x = parseFloat(a.el.style.left) - canvas.offsetLeft;
          const y = parseFloat(a.el.style.top) - canvas.offsetTop;
          pdfDoc.setFont(a.el.style.fontFamily || "Helvetica");
          pdfDoc.setFontSize(parseInt(a.el.style.fontSize) || 14);
          pdfDoc.text(a.el.textContent, x, y + 10);
        });

      if (idx < canvases.length - 1) pdfDoc.addPage();
    });

    pdfDoc.save("annotated_output.pdf");
  }

  function openSettings() {
    document.getElementById("settings-modal").style.display = "block";
    document.getElementById("backdrop").style.display = "block";
  }

  function closeModals() {
    document.getElementById("settings-modal").style.display = "none";
    document.getElementById("backdrop").style.display = "none";
  }

  function toggleDarkMode() {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  }
</script>

</body>
</html>
